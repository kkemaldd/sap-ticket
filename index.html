<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SAP Operasyon Yönetim Paneli</title>
    <!-- Tailwind CSS ve Lucide İkonları -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; -webkit-font-smoothing: antialiased; }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }
        #root:empty {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            background: #0a0f1c;
            color: #4dabf7;
            font-weight: bold;
        }
    </style>
</head>
<body class="bg-[#0a0f1c] text-slate-200">
    <div id="root">Sistem Yükleniyor...</div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, onSnapshot, query, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Değişkenler (Ortam tarafından sağlanır)
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'sap-panel-default';

        // React, ReactDOM ve Babel
        window.ReactDeps = { useState: React.useState, useMemo: React.useMemo, useEffect: React.useEffect, useRef: React.useRef };

        const { useState, useMemo, useEffect, useRef } = window.ReactDeps;

        const Icon = ({ name, size = 20, className = "" }) => {
            useEffect(() => { 
                if (window.lucide) { window.lucide.createIcons(); }
            }, [name]);
            return React.createElement('i', { 'data-lucide': name, style: { width: size, height: size }, className: className });
        };

        const COLORS = {
            status: {
                BEKLEMEDE: 'bg-yellow-500/10 text-yellow-500 border-yellow-500/20',
                TAMAMLANDI: 'bg-emerald-500/10 text-emerald-500 border-emerald-500/20',
                'DEVAM EDİYOR': 'bg-sky-500/10 text-sky-500 border-sky-500/20',
            }
        };

        const formatFullDate = (date) => {
            if (!date) return '-';
            const d = new Date(date);
            return d.toLocaleString('tr-TR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
        };

        const StatCard = ({ name, label, value, color }) => (
            React.createElement('div', { className: "bg-[#151c2d] p-6 rounded-3xl border border-slate-800/50 shadow-sm relative group hover:border-slate-700 transition-all" },
                React.createElement('div', { className: `mb-4 p-2.5 rounded-xl bg-white/5 w-fit ${color}` }, React.createElement(Icon, { name })),
                React.createElement('p', { className: "text-[10px] font-bold text-slate-500 tracking-widest uppercase" }, label),
                React.createElement('p', { className: "text-3xl font-bold mt-1 text-white" }, value)
            )
        );

        const App = () => {
            const [user, setUser] = useState(null);
            const [requests, setRequests] = useState([]);
            const [loading, setLoading] = useState(true);
            const [showModal, setShowModal] = useState(false);
            const [deleteConfirm, setDeleteConfirm] = useState(null);
            const [activeDropdown, setActiveDropdown] = useState(null);
            
            const idRef = useRef();
            const titleRef = useRef();
            const reqRef = useRef();

            // Rule 3: Auth Before Queries - Kimlik doğrulama tamamlanmadan sorgu yapmamalıyız
            useEffect(() => {
                const initAuth = async () => {
                    try {
                        // Kimlik doğrulamayı bekle
                        await signInAnonymously(auth);
                    } catch (err) {
                        console.error("Auth error:", err);
                    }
                };
                initAuth();
                
                // Auth durumu değişimini dinle ve user state'ini güncelle
                const unsubscribe = onAuthStateChanged(auth, (u) => {
                    if (u) {
                        setUser(u);
                    }
                });
                return () => unsubscribe();
            }, []);

            // Data Fetching with onSnapshot - Sadece user varsa dinleme başlat
            useEffect(() => {
                if (!user) return;

                setLoading(true);
                const q = collection(db, 'artifacts', appId, 'public', 'data', 'requests');
                
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    // Rule 2: JavaScript tarafında sıralama
                    setRequests(data.sort((a, b) => new Date(b.openedAt) - new Date(a.openedAt)));
                    setLoading(false);
                }, (err) => {
                    console.error("Firestore error:", err);
                    setLoading(false);
                });

                return () => unsubscribe();
            }, [user]);

            const stats = useMemo(() => {
                const total = requests.length;
                const completed = requests.filter(r => r.status === 'TAMAMLANDI').length;
                const ongoing = requests.filter(r => r.status === 'DEVAM EDİYOR').length;
                const efficiency = total > 0 ? Math.round((completed / total) * 100) : 0;
                return { total, completed, ongoing, efficiency };
            }, [requests]);

            const addTicket = async (e) => {
                e.preventDefault();
                if (!user) {
                    console.error("Oturum açılmadı, kayıt eklenemez.");
                    return;
                }

                const ticketId = idRef.current.value;
                const entry = {
                    title: titleRef.current.value,
                    requester: reqRef.current.value,
                    status: 'BEKLEMEDE',
                    openedAt: new Date().toISOString()
                };

                try {
                    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'requests', ticketId), entry);
                    setShowModal(false);
                } catch (err) {
                    console.error("Ekleme hatası:", err);
                }
            };

            const updateStatus = async (id, newStatus) => {
                if (!user) return;
                try {
                    const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'requests', id);
                    await updateDoc(docRef, { 
                        status: newStatus, 
                        openedAt: new Date().toISOString() 
                    });
                    setActiveDropdown(null);
                } catch (err) {
                    console.error("Güncelleme hatası:", err);
                }
            };

            const deleteRequest = async (id) => {
                if (!user) return;
                try {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'requests', id));
                    setDeleteConfirm(null);
                } catch (err) {
                    console.error("Silme hatası:", err);
                }
            };

            if (loading || !user) return React.createElement('div', { className: "flex h-screen items-center justify-center bg-[#0a0f1c] text-sky-400 font-bold" }, "Veritabanı Bağlantısı Kuruluyor...");

            return (
                React.createElement('div', { className: "min-h-screen p-4 md:p-8 max-w-7xl mx-auto animate-fade-in" },
                    React.createElement('header', { className: "flex flex-col md:flex-row justify-between items-start md:items-center mb-10 gap-4" },
                        React.createElement('div', null,
                            React.createElement('h1', { className: "text-3xl font-bold text-white tracking-tight flex items-center gap-3" },
                                React.createElement(Icon, { name: "layout-dashboard", size: 32, className: "text-[#4dabf7]" }),
                                "SAP Operasyon Paneli"
                            ),
                            React.createElement('p', { className: "text-slate-400 mt-1 text-sm" }, "Bulut senkronizasyonu aktif - Verileriniz güvende")
                        ),
                        React.createElement('button', { 
                            onClick: () => setShowModal(true),
                            className: "bg-[#00a8e8] hover:bg-[#0096d1] text-white px-6 py-3 rounded-xl font-bold flex items-center gap-2 shadow-lg shadow-sky-500/20 transition-all active:scale-95"
                        }, React.createElement(Icon, { name: "plus-circle" }), " Yeni Talep")
                    ),

                    React.createElement('div', { className: "grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-10" },
                        React.createElement(StatCard, { name: "bar-chart-3", label: "TOPLAM TALEP", value: stats.total, color: "text-sky-400" }),
                        React.createElement(StatCard, { name: "check-circle-2", label: "TAMAMLANAN", value: stats.completed, color: "text-emerald-400" }),
                        React.createElement(StatCard, { name: "clock", label: "DEVAM EDEN", value: stats.ongoing, color: "text-yellow-400" }),
                        React.createElement(StatCard, { name: "pie-chart", label: "VERİMLİLİK", value: `%${stats.efficiency}`, color: "text-purple-400" })
                    ),

                    React.createElement('div', { className: "bg-[#151c2d] rounded-3xl border border-slate-800/50 overflow-hidden shadow-2xl" },
                        React.createElement('div', { className: "p-6 border-b border-slate-800/50 bg-white/5" },
                            React.createElement('h3', { className: "text-lg font-semibold text-white italic" }, "Aktif Talepler")
                        ),
                        React.createElement('div', { className: "overflow-x-auto" },
                            React.createElement('table', { className: "w-full text-left" },
                                React.createElement('thead', { className: "bg-white/[0.02]" },
                                    React.createElement('tr', { className: "text-slate-500 text-[10px] uppercase tracking-widest font-bold" },
                                        ['ID', 'BAŞLIK', 'TALEP EDEN', 'SON GÜNCELLEME', 'DURUM', 'İŞLEM'].map(h => 
                                            React.createElement('th', { key: h, className: `px-6 py-4 ${h === 'DURUM' ? 'text-center' : h === 'İŞLEM' ? 'text-right' : ''}` }, h)
                                        )
                                    )
                                ),
                                React.createElement('tbody', { className: "divide-y divide-slate-800/30" },
                                    requests.length === 0 ? 
                                    React.createElement('tr', null, React.createElement('td', { colSpan: 6, className: "px-6 py-10 text-center text-slate-500 italic" }, "Henüz bir talep bulunmuyor.")) :
                                    requests.map(r => (
                                        React.createElement('tr', { key: r.id, className: "hover:bg-white/[0.03] transition-colors group" },
                                            React.createElement('td', { className: "px-6 py-5 text-sky-400 font-mono font-bold" }, `#${r.id}`),
                                            React.createElement('td', { className: "px-6 py-5 font-semibold text-white" }, r.title),
                                            React.createElement('td', { className: "px-6 py-5 text-slate-400 text-sm" }, r.requester),
                                            React.createElement('td', { className: "px-6 py-5" },
                                                React.createElement('div', { className: "flex items-center gap-2 text-[11px] text-slate-500" },
                                                    React.createElement(Icon, { name: "calendar", size: 12 }),
                                                    formatFullDate(r.openedAt)
                                                )
                                            ),
                                            React.createElement('td', { className: "px-6 py-5 text-center relative" },
                                                React.createElement('button', { 
                                                    onClick: () => setActiveDropdown(activeDropdown === r.id ? null : r.id),
                                                    className: `mx-auto px-3 py-1.5 rounded-full text-[10px] font-black border flex items-center gap-1.5 transition-all ${COLORS.status[r.status]}`
                                                }, r.status, React.createElement(Icon, { name: "chevron-down", size: 10 })),
                                                activeDropdown === r.id && React.createElement('div', { className: "absolute top-full left-1/2 -translate-x-1/2 mt-2 w-40 bg-[#1a2235] border border-slate-700 rounded-xl shadow-2xl z-[100] py-2 animate-fade-in" },
                                                    Object.keys(COLORS.status).map(s => (
                                                        React.createElement('button', { key: s, onClick: () => updateStatus(r.id, s), className: "w-full text-left px-4 py-2 text-[10px] font-bold hover:bg-white/10 transition-colors" },
                                                            React.createElement('span', { className: COLORS.status[s].split(' ')[1] }, s)
                                                        )
                                                    ))
                                                )
                                            ),
                                            React.createElement('td', { className: "px-6 py-5 text-right" },
                                                React.createElement('button', { onClick: () => setDeleteConfirm(r.id), className: "p-2 text-slate-500 hover:text-rose-500 transition-colors" },
                                                    React.createElement(Icon, { name: "trash-2", size: 18 })
                                                )
                                            )
                                        )
                                    ))
                                )
                            )
                        )
                    ),

                    showModal && React.createElement('div', { className: "fixed inset-0 bg-black/90 backdrop-blur-md flex items-center justify-center z-[200] p-4" },
                        React.createElement('div', { className: "bg-[#151c2d] w-full max-w-md rounded-3xl border border-slate-700 p-8 shadow-2xl animate-fade-in relative" },
                            React.createElement('button', { onClick: () => setShowModal(false), className: "absolute top-6 right-6 text-slate-500 hover:text-white" }, React.createElement(Icon, { name: "x" })),
                            React.createElement('h2', { className: "text-2xl font-bold mb-6 text-white italic" }, "Yeni Talep Kaydı"),
                            React.createElement('form', { onSubmit: addTicket, className: "space-y-5" },
                                [['Talep ID', idRef, 'text', '1025', true], ['İşlem Başlığı', titleRef, 'text', 'Başlık girin...', false], ['Talep Eden', reqRef, 'text', 'Ad Soyad', false]].map(([label, ref, type, placeholder, focus]) => (
                                    React.createElement('div', { key: label },
                                        React.createElement('label', { className: "block text-[10px] text-slate-500 mb-1.5 font-bold uppercase tracking-wider" }, label),
                                        React.createElement('input', { ref, type, autoFocus: focus, required: true, className: `w-full bg-[#0a0f1c] border border-slate-700 rounded-xl px-4 py-3 text-white focus:border-sky-500 outline-none ${label === 'Talep ID' ? 'text-sky-400 font-mono text-lg' : ''}`, placeholder })
                                    )
                                )),
                                React.createElement('div', { className: "flex gap-3 pt-4" },
                                    React.createElement('button', { type: "button", onClick: () => setShowModal(false), className: "flex-1 py-3 text-white font-medium hover:bg-white/5 rounded-xl border border-slate-700 transition-colors" }, "Vazgeç"),
                                    React.createElement('button', { type: "submit", className: "flex-1 py-3 bg-sky-600 text-white font-bold rounded-xl shadow-lg hover:bg-sky-500 transition-all" }, "Kaydet")
                                )
                            )
                        )
                    ),

                    deleteConfirm && React.createElement('div', { className: "fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-[300] p-4" },
                        React.createElement('div', { className: "bg-[#151c2d] p-8 rounded-3xl border border-rose-500/30 text-center max-w-sm w-full shadow-2xl animate-fade-in" },
                            React.createElement(Icon, { name: "alert-triangle", size: 48, className: "text-rose-500 mx-auto mb-4" }),
                            React.createElement('h3', { className: "text-xl font-bold mb-2 text-white" }, "Kayıt Siliniyor"),
                            React.createElement('p', { className: "text-slate-400 text-sm mb-6" }, `#${deleteConfirm} ID'li talebi silmek istediğinize emin misiniz?`),
                            React.createElement('div', { className: "flex gap-3" },
                                React.createElement('button', { onClick: () => setDeleteConfirm(null), className: "flex-1 py-2.5 border border-slate-700 rounded-xl text-white" }, "Hayır"),
                                React.createElement('button', { onClick: () => deleteRequest(deleteConfirm), className: "flex-1 py-2.5 bg-rose-600 text-white rounded-xl font-bold" }, "Evet, Sil")
                            )
                        )
                    )
                )
            );
        };

        // Render call
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(React.createElement(App));
    </script>

    <!-- React kütüphaneleri -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
</body>
</html>
